version: '3.8'

# access local hanachan app on http://localhost:8888

services:
  frontend-next:
    build:
      context: ./frontend-next
    image: coil/hanachan.org:frontend-next
    ports:
      - '127.0.0.1:3000:3000'
    environment:
      - ALLOWED_ORIGINS=http://localhost:3000,http://localhost:8888
      - JWT_SECRET=your-development-secret-key
      - EXPRESS_API_URL=http://express-db:8000
      - FLASK_API_URL=http://flask-dynamic-db:5100
      - STUDY_PLAN_API_URL=http://study-plan-service:5500
      - DICTIONARY_API_URL=http://dictionary-db:5200
      - HANACHAN_API_URL=http://hanachan:5400
      - MYSQL_HOST=mysql-db
      - MYSQL_PORT=3306
      - GA_MEASUREMENT_ID=
    restart: unless-stopped
    networks:
      - hanachan-network

  # hanachan-service:
  #   build:
  #     context: ./backend/hanachan
  #   image: coil/hanachan.org:hanachan-service
  #   ports:
  #     - '127.0.0.1:5300:5300'
  #   restart: unless-stopped
  #   networks:
  #     - hanachan-network


  express-db:
    build:
      context: ./backend/express
    image: coil/hanachan.org:express-db
    ports:
      - '127.0.0.1:8000:8000'
    environment:
      - ALLOWED_ORIGINS=http://localhost:3000,http://localhost:8888
      - JWT_SECRET=your-development-secret-key
    restart: unless-stopped
    networks:
      - hanachan-network

  flask-dynamic-db:
    build:
      context: ./backend/flask
    image: coil/hanachan.org:flask-dynamic-db
    ports:
      - '127.0.0.1:5100:5100'
    environment:
      - ALLOWED_ORIGINS=http://localhost:3000,http://localhost:8888
      - JWT_SECRET=your-development-secret-key
    volumes:
      - ./user_db:/data/db
    restart: unless-stopped
    networks:
      - hanachan-network

  dictionary-db:
    build:
      context: ./backend/python-dictionary
    image: coil/hanachan.org:python-dictionary
    ports:
      - '127.0.0.1:5200:5200'
    environment:
      - ALLOWED_ORIGINS=http://localhost:3000,http://localhost:8888
    restart: unless-stopped
    networks:
      - hanachan-network

  hanachan:
    build:
      context: ./backend/hanachan
    image: coil/hanachan.org:hanachan
    ports:
      - '127.0.0.1:5400:5400'
    environment:
      - ALLOWED_ORIGINS=http://localhost:3000,http://localhost:8888
      - JWT_SECRET=your-development-secret-key
      - DATABASE_URL=postgresql://hanachan:hanachan@hanachan-db:5432/hanachan_db
      - MEMORY_MODE=live
      - OLLAMA_BASE_URL=http://host.docker.internal:11434
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USERNAME=neo4j
      - NEO4J_PASSWORD=password
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-text-embedding-3-small}
      - EMBEDDING_DIMENSION=${EMBEDDING_DIMENSION:-1536}
      - LLM_PROVIDER=${LLM_PROVIDER:-openai}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL_NAME=${OPENAI_MODEL_NAME:-gpt-4-turbo}
      - RESOURCES_API_URL=http://flask-dynamic-db:5100
      - FLASK_RUN_PORT=5400
      - REDIS_URL=redis://redis:6379/0
      - PYTHONUNBUFFERED=1
    depends_on:
      - hanachan-db
      - neo4j
      - qdrant
      - redis
    restart: unless-stopped
    networks:
      - hanachan-network

  hanachan-db:
    image: postgres:15
    environment:
      - POSTGRES_USER=hanachan
      - POSTGRES_PASSWORD=hanachan
      - POSTGRES_DB=hanachan_db
    volumes:
      - hanachan_postgres_data:/var/lib/postgresql/data
    networks:
      - hanachan-network

  study-plan-service:
    build:
      context: ./backend/study-plan-service
    image: coil/hanachan.org:study-plan-service
    ports:
      - '127.0.0.1:5500:5500'
    environment:
      - ALLOWED_ORIGINS=http://localhost:3000,http://localhost:8888
      - JWT_SECRET=your-development-secret-key
      - MONGO_URI_FLASK=mongodb://flask-dynamic-db:27017/flaskFlashcardDB
    restart: unless-stopped
    networks:
      - hanachan-network

  neo4j:
    image: neo4j:5.15.0
    ports:
      - '127.0.0.1:7474:7474'
      - '127.0.0.1:7687:7687'
    environment:
      - NEO4J_AUTH=neo4j/password
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_security_procedures_allowlist=apoc.*
    volumes:
      - neo4j_data:/data
    restart: unless-stopped
    networks:
      - hanachan-network

  qdrant:
    image: qdrant/qdrant:latest
    ports:
      - '127.0.0.1:6333:6333'
    volumes:
      - qdrant_data:/qdrant/storage
    restart: unless-stopped
    networks:
      - hanachan-network

  nginx:
    image: nginx:latest
    ports:
      - '127.0.0.1:8888:80'
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped
    networks:
      - hanachan-network

  redis:
    image: redis:alpine
    ports:
      - '127.0.0.1:6379:6379'
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    restart: unless-stopped
    networks:
      - hanachan-network

  worker:
    build:
      context: ./backend/hanachan
    image: coil/hanachan.org:hanachan
    command: ./run_worker.sh
    environment:
      - REDIS_URL=redis://redis:6379/0
      - DATABASE_URL=postgresql://hanachan:hanachan@hanachan-db:5432/hanachan_db
      - OLLAMA_BASE_URL=http://host.docker.internal:11434
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USERNAME=neo4j
      - NEO4J_PASSWORD=password
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - LLM_PROVIDER=${LLM_PROVIDER:-openai}
      - OPENAI_MODEL_NAME=${OPENAI_MODEL_NAME:-gpt-4-turbo}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-text-embedding-3-small}
      - EMBEDDING_DIMENSION=${EMBEDDING_DIMENSION:-1536}
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app
      - RESOURCES_API_URL=http://flask-dynamic-db:5100
    depends_on:
      - redis
      - hanachan-db
      - neo4j
      - qdrant
    restart: unless-stopped
    networks:
      - hanachan-network

volumes:
  user_db:
  mysql_data:
  hanachan_postgres_data:
  neo4j_data:
  qdrant_data:
  redis_data:


networks:
  hanachan-network:
