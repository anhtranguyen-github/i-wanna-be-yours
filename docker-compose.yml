version: '3.8'

# access local hanachan app on http://localhost:8888

services:
  frontend-next:
    build:
      context: ./frontend-next
    image: coil/hanachan.org:frontend-next
    ports:
      - '127.0.0.1:3000:3000'
    environment:
      - ALLOWED_ORIGINS=http://localhost:3000,http://localhost:8888
      - JWT_SECRET=your-development-secret-key
      - EXPRESS_API_URL=http://express-db:8000
      - FLASK_API_URL=http://flask-dynamic-db:5100
      - STUDY_PLAN_API_URL=http://study-plan-service:5500
      - DICTIONARY_API_URL=http://dictionary-db:5200
      - HANACHAN_API_URL=http://hanachan:5400
      - MYSQL_HOST=mysql-db
      - MYSQL_PORT=3306
      - GA_MEASUREMENT_ID=
    restart: unless-stopped
    networks:
      - hanachan-network

  # hanachan-service:
  #   build:
  #     context: ./backend/hanachan
  #   image: coil/hanachan.org:hanachan-service
  #   ports:
  #     - '127.0.0.1:5300:5300'
  #   restart: unless-stopped
  #   networks:
  #     - hanachan-network


  express-db:
    build:
      context: ./backend/express
    image: coil/hanachan.org:express-db
    ports:
      - '127.0.0.1:8000:8000'
    environment:
      - ALLOWED_ORIGINS=http://localhost:3000,http://localhost:8888
      - JWT_SECRET=your-development-secret-key
    restart: unless-stopped
    networks:
      - hanachan-network

  flask-dynamic-db:
    build:
      context: ./backend/flask
    image: coil/hanachan.org:flask-dynamic-db
    ports:
      - '127.0.0.1:5100:5100'
    environment:
      - ALLOWED_ORIGINS=http://localhost:3000,http://localhost:8888
      - JWT_SECRET=your-development-secret-key
    volumes:
      - ./user_db:/data/db
    restart: unless-stopped
    networks:
      - hanachan-network

  dictionary-db:
    build:
      context: ./backend/python-dictionary
    image: coil/hanachan.org:python-dictionary
    ports:
      - '127.0.0.1:5200:5200'
    environment:
      - ALLOWED_ORIGINS=http://localhost:3000,http://localhost:8888
    restart: unless-stopped
    networks:
      - hanachan-network

  hanachan:
    build:
      context: ./backend/hanachan
    image: coil/hanachan.org:hanachan
    ports:
      - '127.0.0.1:5400:5400'
    environment:
      - ALLOWED_ORIGINS=http://localhost:3000,http://localhost:8888
      - JWT_SECRET=your-development-secret-key
      - DATABASE_URL=postgresql://hanachan:hanachan@hanachan-db:5432/hanachan_db
    depends_on:
      - hanachan-db
    restart: unless-stopped
    networks:
      - hanachan-network

  hanachan-db:
    image: postgres:15
    environment:
      - POSTGRES_USER=hanachan
      - POSTGRES_PASSWORD=hanachan
      - POSTGRES_DB=hanachan_db
    volumes:
      - hanachan_postgres_data:/var/lib/postgresql/data
    networks:
      - hanachan-network

  study-plan-service:
    build:
      context: ./backend/study-plan-service
    image: coil/hanachan.org:study-plan-service
    ports:
      - '127.0.0.1:5500:5500'
    environment:
      - ALLOWED_ORIGINS=http://localhost:3000,http://localhost:8888
      - JWT_SECRET=your-development-secret-key
      - MONGO_URI_FLASK=mongodb://flask-dynamic-db:27017/flaskFlashcardDB
    restart: unless-stopped
    networks:
      - hanachan-network

  nginx:
    image: nginx:latest
    ports:
      - '127.0.0.1:8888:80'
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped
    networks:
      - hanachan-network

volumes:
  user_db:
  mysql_data:
  hanachan_postgres_data:


networks:
  hanachan-network:
